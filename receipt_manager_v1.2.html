<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>해외출장 영수증 관리시스템 v1.2</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
    <style>
        /* 기본 레이아웃 및 컨테이너 스타일 */
        .main-container {
            display: flex;
            height: 500px;
            gap: 1rem;
        }
        .image-panel { flex: 0 0 40%; height: 100%; }
        .form-panel { flex: 0 0 60%; height: 100%; }
        .image-container {
            width: 100%; height: 100%; overflow-y: auto; overflow-x: hidden;
            border: 2px dashed #cbd5e0; border-radius: 0.5rem; position: relative;
            background: #f7fafc; cursor: pointer; transition: border-color 0.3s;
        }
        .receipt-image { width: 100%; height: auto; display: block; }
        .form-container {
            height: 100%; overflow-y: auto; padding: 1rem; background: white;
            border-radius: 0.5rem; border: 1px solid #e2e8f0;
        }
        /* 테이블 정렬 아이콘 스타일 */
        .sortable-header { cursor: pointer; user-select: none; position: relative; }
        .sortable-header:hover { background-color: #f1f5f9; }
        .sort-icon { margin-left: 0.25rem; font-size: 0.75rem; opacity: 0.5; }
        .sort-icon.active { opacity: 1; color: #3b82f6; }
        /* 차트 및 통계 그리드 스타일 */
        .chart-container { height: 300px; margin-bottom: 1rem; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; margin-top: 1rem; }
        
        /* 모달 및 알림 스타일 (개선) */
        .modal-overlay {
            position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.6);
            display: flex; align-items: center; justify-content: center; z-index: 100;
            opacity: 0; transition: opacity 0.3s; pointer-events: none;
        }
        .modal-overlay.visible { opacity: 1; pointer-events: auto; }
        .modal-content {
            background: white; padding: 2rem; border-radius: 0.5rem; text-align: center;
            transform: scale(0.95); transition: transform 0.3s; max-width: 90%;
        }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .toast-notification {
            position: fixed; bottom: 1.5rem; left: 50%; transform: translateX(-50%);
            background-color: rgba(17, 24, 39, 0.8); color: white; padding: 0.75rem 1.5rem;
            border-radius: 9999px; z-index: 110; opacity: 0;
            transition: opacity 0.5s, transform 0.5s;
        }
        .toast-notification.show { opacity: 1; transform: translate(-50%, -10px); }

        /* 반응형 디자인 */
        @media (max-width: 1024px) { .stats-grid { grid-template-columns: 1fr; } }
        @media (max-width: 768px) {
            .main-container { flex-direction: column; height: auto; }
            .image-panel, .form-panel { flex: none; height: 350px; }
        }
    </style>
</head>
<body class="bg-gray-50 p-4 font-sans">
    <div class="max-w-7xl mx-auto">
        <!-- 페이지 헤더 -->
        <header class="text-center mb-6">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">
                <i class="fas fa-receipt mr-3 text-blue-500"></i>해외출장 영수증 관리시스템 v1.2
            </h1>
            <p class="text-gray-600">해외출장 시 영수증 정산 관리를 위한 브라우저 기반 시스템</p>
            <p class="text-sm text-gray-500 mt-1">by Brian Myungsun Lee (leeclean@gmail.com) / 2025.08</p>
        </header>

        <!-- 메인 입력 영역 -->
        <div class="main-container mb-6">
            <!-- 영수증 이미지 패널 -->
            <div class="image-panel">
                <h3 class="text-lg font-semibold mb-3 text-gray-700"><i class="fas fa-image mr-2"></i>영수증 미리보기</h3>
                <div class="image-container" id="imageContainer">
                    <div class="absolute inset-0 flex items-center justify-center text-gray-400" id="imagePlaceholder">
                        <div class="text-center">
                            <i class="fas fa-cloud-upload-alt text-4xl mb-2"></i>
                            <p>영수증 이미지를 업로드하세요</p>
                            <p class="text-sm">드래그 앤 드롭 또는 클릭</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 영수증 정보 입력 폼 -->
            <div class="form-panel">
                <h3 class="text-lg font-semibold mb-3 text-gray-700">
                    <i class="fas fa-edit mr-2"></i>영수증 정보 입력
                    <span id="exchangeRateDisplay" class="text-sm text-blue-600 ml-2"></span>
                </h3>
                <div class="form-container">
                    <form id="receiptForm" class="space-y-4">
                        <!-- 입력 필드들 (기존과 동일) -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="receiptDate" class="block text-sm font-medium text-gray-700 mb-1">날짜</label>
                                <input type="date" id="receiptDate" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">시간</label>
                                <div class="flex items-center space-x-2">
                                    <select id="ampm" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"><option value="AM">AM</option><option value="PM">PM</option></select>
                                    <select id="hour" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"></select>
                                    <span>:</span>
                                    <select id="minute" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"></select>
                                </div>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-10 gap-4">
                            <div class="md:col-span-3">
                                <label for="receiptCategory" class="block text-sm font-medium text-gray-700 mb-1">항목</label>
                                <select id="receiptCategory" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                                    <option value="식비">식비</option><option value="교통비">교통비</option>
                                    <option value="접대비">접대비</option><option value="기타">기타</option>
                                </select>
                            </div>
                            <div class="md:col-span-7">
                                <label for="receiptPurpose" class="block text-sm font-medium text-gray-700 mb-1">사용목적</label>
                                <input type="text" id="receiptPurpose" placeholder="예: 출장 시 식사/이동/접대 등" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
                        <div>
                            <label for="merchantName" class="block text-sm font-medium text-gray-700 mb-1">사용처</label>
                            <input type="text" id="merchantName" placeholder="사용처 입력" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div><label for="subtotal" class="block text-sm font-medium text-gray-700 mb-1">Subtotal (USD)</label><input type="number" id="subtotal" step="0.01" placeholder="0.00" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"></div>
                            <div><label for="tax" class="block text-sm font-medium text-gray-700 mb-1">Tax (USD)</label><input type="number" id="tax" step="0.01" placeholder="0.00" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"></div>
                            <div><label for="tip" class="block text-sm font-medium text-gray-700 mb-1">Tip (USD)</label><input type="number" id="tip" step="0.01" placeholder="0.00" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"></div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div><label for="totalUsd" class="block text-sm font-medium text-gray-700 mb-1">Total (USD)</label><input type="number" id="totalUsd" step="0.01" readonly class="w-full p-2 border border-gray-300 rounded-md bg-gray-100"></div>
                            <div><label for="appliedExchangeRate" class="block text-sm font-medium text-gray-700 mb-1">적용 환율 (KRW)</label><input type="number" id="appliedExchangeRate" step="0.01" placeholder="오늘의 환율 적용" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"></div>
                            <div><label for="totalKrw" class="block text-sm font-medium text-gray-700 mb-1">Total (KRW)</label><input type="text" id="totalKrw" readonly class="w-full p-2 border border-gray-300 rounded-md bg-gray-100"></div>
                        </div>
                    </form>
                    
                    <div class="flex space-x-2 mt-6">
                        <input type="file" id="imageUpload" accept="image/*" class="hidden">
                        <button id="uploadBtn" class="flex-1 bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition-colors"><i class="fas fa-upload mr-2"></i>이미지 업로드</button>
                        <button id="ocrBtn" class="flex-1 bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600 transition-colors" disabled><i class="fas fa-eye mr-2"></i>OCR 처리</button>
                        <button id="saveBtn" class="flex-1 bg-purple-500 text-white px-4 py-2 rounded-md hover:bg-purple-600 transition-colors"><i class="fas fa-save mr-2"></i>저장</button>
                        <button id="resetBtn" type="button" class="flex-1 bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 transition-colors"><i class="fas fa-undo mr-2"></i>초기화</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 영수증 기록 테이블 -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex justify-between items-center mb-4 flex-wrap gap-4">
                <h2 class="text-2xl font-bold text-gray-800"><i class="fas fa-table mr-2"></i>영수증 기록 <span id="currentExchangeRate" class="text-lg text-blue-600 ml-2"></span></h2>
                <button id="exportBtn" class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600 transition-colors"><i class="fas fa-download mr-2"></i>CSV 내보내기</button>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full table-auto border-collapse">
                    <thead>
                        <tr class="bg-gray-50">
                            <th class="sortable-header border px-4 py-2 text-left" data-sort="date">날짜 <i class="fas fa-sort sort-icon" id="sort-date"></i></th>
                            <th class="border px-4 py-2 text-center">시간</th>
                            <th class="sortable-header border px-4 py-2 text-left" data-sort="category">항목 <i class="fas fa-sort sort-icon" id="sort-category"></i></th>
                            <th class="border px-4 py-2 text-left">사용목적</th>
                            <th class="sortable-header border px-4 py-2 text-left" data-sort="merchant">사용처 <i class="fas fa-sort sort-icon" id="sort-merchant"></i></th>
                            <th class="border px-4 py-2 text-right">Total(USD)</th>
                            <th class="border px-4 py-2 text-right">적용환율(KRW)</th>
                            <th class="border px-4 py-2 text-right">Total(KRW)</th>
                            <th class="border px-4 py-2 text-center">이미지</th>
                            <th class="border px-4 py-2 text-center">수정/삭제</th>
                        </tr>
                    </thead>
                    <tbody id="receiptTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- 통계 요약 대시보드 -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-6"><i class="fas fa-chart-bar mr-2"></i>통계 요약 대시보드</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-blue-50 p-4 rounded-lg text-center"><div class="text-blue-600 text-sm font-medium">총 영수증</div><div class="text-2xl font-bold text-blue-800" id="totalReceipts">0</div></div>
                <div class="bg-green-50 p-4 rounded-lg text-center"><div class="text-green-600 text-sm font-medium">총 지출 (USD)</div><div class="text-2xl font-bold text-green-800" id="totalSpentUSD">$0.00</div></div>
                <div class="bg-purple-50 p-4 rounded-lg text-center"><div class="text-purple-600 text-sm font-medium">총 지출 (KRW)</div><div class="text-2xl font-bold text-purple-800" id="totalSpentKRW">₩0</div></div>
                <div class="bg-yellow-50 p-4 rounded-lg text-center"><div class="text-yellow-600 text-sm font-medium">평균 지출</div><div class="text-2xl font-bold text-yellow-800" id="averageSpent">$0.00</div></div>
            </div>
            <div class="stats-grid">
                <div class="bg-gray-50 p-4 rounded-lg"><h3 class="text-lg font-semibold mb-2">항목별 지출 분포</h3><div class="chart-container"><canvas id="categoryChart"></canvas></div></div>
                <div class="bg-gray-50 p-4 rounded-lg"><h3 class="text-lg font-semibold mb-2">사용처별 지출 분포</h3><div class="chart-container"><canvas id="merchantChart"></canvas></div></div>
            </div>
        </div>
    </div>

    <!-- 모달 및 토스트 알림을 위한 컨테이너 -->
    <div id="modalContainer"></div>
    <div id="toastContainer"></div>

    <script>
        // ===================================================================================
        // 전역 변수 및 상태 관리 (Global Variables & State Management)
        // ===================================================================================
        let receipts = [];
        let currentExchangeRate = 1390.00;
        let editingIndex = -1;
        let currentImage = null;
        let sortState = { column: 'date', direction: 'desc' };
        let categoryChart, merchantChart;

        // ===================================================================================
        // DOM 요소 캐싱 (DOM Element Caching)
        // ===================================================================================
        const dom = {
            receiptForm: document.getElementById('receiptForm'), receiptDate: document.getElementById('receiptDate'),
            ampm: document.getElementById('ampm'), hour: document.getElementById('hour'), minute: document.getElementById('minute'),
            receiptCategory: document.getElementById('receiptCategory'), receiptPurpose: document.getElementById('receiptPurpose'),
            merchantName: document.getElementById('merchantName'), subtotal: document.getElementById('subtotal'),
            tax: document.getElementById('tax'), tip: document.getElementById('tip'), totalUsd: document.getElementById('totalUsd'),
            appliedExchangeRate: document.getElementById('appliedExchangeRate'), totalKrw: document.getElementById('totalKrw'),
            uploadBtn: document.getElementById('uploadBtn'), ocrBtn: document.getElementById('ocrBtn'),
            saveBtn: document.getElementById('saveBtn'), resetBtn: document.getElementById('resetBtn'),
            exportBtn: document.getElementById('exportBtn'), imageUpload: document.getElementById('imageUpload'),
            imageContainer: document.getElementById('imageContainer'), imagePlaceholder: document.getElementById('imagePlaceholder'),
            receiptTableBody: document.getElementById('receiptTableBody'), exchangeRateDisplay: document.getElementById('exchangeRateDisplay'),
            currentExchangeRate: document.getElementById('currentExchangeRate'), totalReceipts: document.getElementById('totalReceipts'),
            totalSpentUSD: document.getElementById('totalSpentUSD'), totalSpentKRW: document.getElementById('totalSpentKRW'),
            averageSpent: document.getElementById('averageSpent'), categoryChartCanvas: document.getElementById('categoryChart')?.getContext('2d'),
            merchantChartCanvas: document.getElementById('merchantChart')?.getContext('2d'),
            modalContainer: document.getElementById('modalContainer'), toastContainer: document.getElementById('toastContainer'),
        };

        // ===================================================================================
        // 유틸리티 함수 (Utility Functions)
        // ===================================================================================
        const safeParseFloat = (value) => (isNaN(parseFloat(value)) || value === '' || value === null) ? 0 : parseFloat(value);
        const safeToFixed = (value, digits = 2) => safeParseFloat(value).toFixed(digits);

        // ===================================================================================
        // 초기화 및 이벤트 리스너 설정 (Initialization & Event Listeners)
        // ===================================================================================
        document.addEventListener('DOMContentLoaded', () => {
            initializeEventListeners();
            initializeTimeSelectors();
            loadReceipts();
            initializeCharts();
            fetchExchangeRate().then(() => {
                resetForm(); // 환율 로드 후 폼 초기화
                renderAll();
            });
        });

        function initializeEventListeners() {
            ['subtotal', 'tax', 'tip', 'appliedExchangeRate'].forEach(id => dom[id].addEventListener('input', calculateTotals));
            dom.uploadBtn.addEventListener('click', () => dom.imageUpload.click());
            dom.ocrBtn.addEventListener('click', processOCR);
            dom.saveBtn.addEventListener('click', saveReceipt);
            dom.resetBtn.addEventListener('click', resetForm);
            dom.exportBtn.addEventListener('click', exportToCSV);
            dom.imageUpload.addEventListener('change', handleImageUpload);
            dom.imageContainer.addEventListener('dragover', (e) => { e.preventDefault(); e.currentTarget.style.borderColor = '#3b82f6'; });
            dom.imageContainer.addEventListener('dragleave', (e) => { e.preventDefault(); e.currentTarget.style.borderColor = '#cbd5e0'; });
            dom.imageContainer.addEventListener('drop', handleImageDrop);
            dom.imageContainer.addEventListener('click', (e) => { if (e.target.tagName !== 'IMG') dom.imageUpload.click(); });
            dom.receiptTableBody.addEventListener('click', handleTableClick);
            document.querySelector('thead').addEventListener('click', handleSortClick);
        }

        // ===================================================================================
        // 데이터 처리 (CRUD & Storage)
        // ===================================================================================
        const loadReceipts = () => receipts = JSON.parse(localStorage.getItem('receipts')) || [];
        const storeReceipts = () => localStorage.setItem('receipts', JSON.stringify(receipts));
        
        function saveReceipt() {
            if (!dom.receiptDate.value || !dom.merchantName.value.trim()) {
                showToast('날짜와 사용처는 필수 입력 항목입니다.', 'error');
                return;
            }
            let hour24 = safeParseFloat(dom.hour.value);
            if (dom.ampm.value === 'AM' && hour24 === 12) hour24 = 0;
            if (dom.ampm.value === 'PM' && hour24 !== 12) hour24 += 12;

            const totalUsdValue = safeParseFloat(dom.totalUsd.value);
            const exchangeRateToSave = safeParseFloat(dom.appliedExchangeRate.value) || currentExchangeRate;
            
            const receipt = {
                date: dom.receiptDate.value, time: `${String(hour24).padStart(2, '0')}:${dom.minute.value}`,
                category: dom.receiptCategory.value, purpose: dom.receiptPurpose.value.trim(),
                merchant: dom.merchantName.value.trim(), subtotal: safeParseFloat(dom.subtotal.value),
                tax: safeParseFloat(dom.tax.value), tip: safeParseFloat(dom.tip.value),
                totalUsd: totalUsdValue, exchangeRate: exchangeRateToSave,
                totalKrw: Math.round(totalUsdValue * exchangeRateToSave), image: currentImage,
                timestamp: Date.now()
            };

            if (editingIndex >= 0) {
                receipts[editingIndex] = receipt;
                showToast('영수증이 수정되었습니다.');
            } else {
                receipts.push(receipt);
                showToast('영수증이 저장되었습니다.');
            }
            storeReceipts();
            resetForm();
            renderAll();
        }

        function editReceipt(index) {
            const receipt = receipts[index];
            if (!receipt) return;
            editingIndex = index;

            dom.receiptDate.value = receipt.date;
            dom.receiptCategory.value = receipt.category || '기타';
            dom.receiptPurpose.value = receipt.purpose || '';
            dom.merchantName.value = receipt.merchant;
            dom.subtotal.value = safeToFixed(receipt.subtotal, 2);
            dom.tax.value = safeToFixed(receipt.tax, 2);
            dom.tip.value = safeToFixed(receipt.tip, 2);
            dom.appliedExchangeRate.value = safeToFixed(receipt.exchangeRate, 2);
            
            const [hour24, minute] = receipt.time.split(':');
            let hour12 = parseInt(hour24, 10) % 12 || 12;
            dom.ampm.value = parseInt(hour24, 10) >= 12 ? 'PM' : 'AM';
            dom.hour.value = String(hour12).padStart(2, '0');
            dom.minute.value = minute;

            if (receipt.image) {
                currentImage = receipt.image;
                displayImage(receipt.image);
                dom.ocrBtn.disabled = false;
            } else {
                clearImage();
            }
            calculateTotals();
            updateSaveButton(true); // 수정 모드로 버튼 변경
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function deleteReceipt(index) {
            showConfirmationModal('정말로 이 영수증을 삭제하시겠습니까?', () => {
                receipts.splice(index, 1);
                storeReceipts();
                renderAll();
                showToast('영수증이 삭제되었습니다.');
            });
        }

        // ===================================================================================
        // 렌더링 및 UI 업데이트 (Rendering & UI Updates)
        // ===================================================================================
        function renderAll() {
            sortTable(sortState.column, true); // 정렬 상태 유지하며 렌더링
            updateStatistics();
            updateCharts();
        }

        function renderReceiptsTable() {
            dom.receiptTableBody.innerHTML = receipts.map((receipt, index) => `
                <tr class="hover:bg-gray-50">
                    <td class="border px-4 py-2">${receipt.date.replace(/-/g, '/')}</td>
                    <td class="border px-4 py-2 text-center">${receipt.time}</td>
                    <td class="border px-4 py-2">${receipt.category || ''}</td>
                    <td class="border px-4 py-2">${receipt.purpose || ''}</td>
                    <td class="border px-4 py-2">${receipt.merchant}</td>
                    <td class="border px-4 py-2 text-right font-semibold">$${safeToFixed(receipt.totalUsd, 2)}</td>
                    <td class="border px-4 py-2 text-right">${safeParseFloat(receipt.exchangeRate).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                    <td class="border px-4 py-2 text-right font-semibold">₩${Math.round(safeParseFloat(receipt.totalKrw)).toLocaleString()}</td>
                    <td class="border px-4 py-2 text-center">${receipt.image ? `<img src="${receipt.image}" alt="Receipt" class="w-12 h-12 object-cover mx-auto cursor-pointer rounded-md" data-action="view-image">` : '없음'}</td>
                    <td class="border px-4 py-2 text-center">
                        <button data-action="edit" data-index="${index}" class="bg-blue-500 text-white px-2 py-1 rounded text-xs mr-1 hover:bg-blue-600 transition-colors"><i class="fas fa-edit"></i></button>
                        <button data-action="delete" data-index="${index}" class="bg-red-500 text-white px-2 py-1 rounded text-xs hover:bg-red-600 transition-colors"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        }
        
        function updateStatistics() {
            const totalReceiptsCount = receipts.length;
            const totalSpentUSD = receipts.reduce((sum, r) => sum + safeParseFloat(r.totalUsd), 0);
            const totalSpentKRW = receipts.reduce((sum, r) => sum + safeParseFloat(r.totalKrw), 0);
            const averageSpentUSD = totalReceiptsCount > 0 ? totalSpentUSD / totalReceiptsCount : 0;
            const averageSpentKRW = totalReceiptsCount > 0 ? totalSpentKRW / totalReceiptsCount : 0;
            
            dom.totalReceipts.textContent = totalReceiptsCount;
            dom.totalSpentUSD.textContent = `$${safeToFixed(totalSpentUSD, 2)}`;
            dom.totalSpentKRW.textContent = `₩${Math.round(totalSpentKRW).toLocaleString()}`;
            dom.averageSpent.textContent = `$${safeToFixed(averageSpentUSD, 2)} (₩${Math.round(averageSpentKRW).toLocaleString()})`;
        }
        
        function updateCharts() {
            if (!categoryChart || !merchantChart) return;
            // 카테고리 차트
            const categoryData = {};
            receipts.forEach(r => { categoryData[r.category] = (categoryData[r.category] || 0) + safeParseFloat(r.totalUsd); });
            const sortedCategories = Object.entries(categoryData).sort((a, b) => b[1] - a[1]);
            categoryChart.data.labels = sortedCategories.map(([cat]) => cat);
            categoryChart.data.datasets[0].data = sortedCategories.map(([, amount]) => amount);
            categoryChart.update();
            // 사용처 차트
            const merchantData = {};
            receipts.forEach(r => { merchantData[r.merchant] = (merchantData[r.merchant] || 0) + safeParseFloat(r.totalUsd); });
            const sortedMerchants = Object.entries(merchantData).sort((a, b) => b[1] - a[1]).slice(0, 8);
            merchantChart.data.labels = sortedMerchants.map(([mer]) => mer);
            merchantChart.data.datasets[0].data = sortedMerchants.map(([, amount]) => amount);
            merchantChart.update();
        }

        function updateSaveButton(isEditing) {
            if (isEditing) {
                dom.saveBtn.innerHTML = '<i class="fas fa-check mr-2"></i>수정';
                dom.saveBtn.classList.replace('bg-purple-500', 'bg-yellow-500');
                dom.saveBtn.classList.replace('hover:bg-purple-600', 'hover:bg-yellow-600');
            } else {
                dom.saveBtn.innerHTML = '<i class="fas fa-save mr-2"></i>저장';
                dom.saveBtn.classList.replace('bg-yellow-500', 'bg-purple-500');
                dom.saveBtn.classList.replace('hover:bg-yellow-600', 'hover:bg-purple-600');
            }
        }

        // ===================================================================================
        // 이벤트 핸들러 (Event Handlers)
        // ===================================================================================
        const handleSortClick = (e) => { const header = e.target.closest('.sortable-header'); if (header) sortTable(header.dataset.sort); };
        const handleTableClick = (e) => {
            const target = e.target.closest('button, img');
            if (!target) return;
            const action = target.dataset.action;
            const index = target.dataset.index;
            if (action === 'edit') editReceipt(parseInt(index, 10));
            else if (action === 'delete') deleteReceipt(parseInt(index, 10));
            else if (action === 'view-image') showImageModal(target.src);
        };
        const handleImageDrop = (e) => { e.preventDefault(); e.currentTarget.style.borderColor = '#cbd5e0'; if (e.dataTransfer.files.length > 0) handleImageFile(e.dataTransfer.files[0]); };
        const handleImageUpload = (e) => { if (e.target.files[0]) handleImageFile(e.target.files[0]); };

        // ===================================================================================
        // 기능별 함수 (Feature-specific Functions)
        // ===================================================================================
        function initializeTimeSelectors() {
            for (let i = 1; i <= 12; i++) dom.hour.add(new Option(String(i).padStart(2, '0'), String(i).padStart(2, '0')));
            for (let i = 0; i <= 59; i++) dom.minute.add(new Option(String(i).padStart(2, '0'), String(i).padStart(2, '0')));
        }

        async function fetchExchangeRate() {
            try {
                const response = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                currentExchangeRate = safeParseFloat(data.rates.KRW) || 1390.00;
            } catch (error) {
                console.error('환율 API 오류, 기본값 사용:', error);
                showToast('환율 정보를 가져오지 못했습니다. 기본값이 적용됩니다.', 'error');
            } finally {
                const rateText = `(오늘의 환율: ${currentExchangeRate.toLocaleString()})`;
                dom.currentExchangeRate.textContent = rateText;
                dom.exchangeRateDisplay.textContent = `환율: ${currentExchangeRate.toLocaleString()}`;
                dom.appliedExchangeRate.placeholder = `현재: ${currentExchangeRate.toFixed(2)}`;
            }
        }

        function handleImageFile(file) {
            if (!file.type.startsWith('image/')) {
                showToast('이미지 파일만 업로드 가능합니다.', 'error');
                return;
            }
            const reader = new FileReader();
            reader.onload = (e) => {
                currentImage = e.target.result;
                displayImage(currentImage);
                dom.ocrBtn.disabled = false;
            };
            reader.readAsDataURL(file);
        }

        function displayImage(imageSrc) {
            dom.imagePlaceholder.style.display = 'none';
            let img = dom.imageContainer.querySelector('img');
            if (!img) {
                img = document.createElement('img');
                img.className = 'receipt-image';
                dom.imageContainer.appendChild(img);
            }
            img.src = imageSrc;
        }

        function clearImage() {
            const img = dom.imageContainer.querySelector('img');
            if (img) img.remove();
            dom.imagePlaceholder.style.display = 'flex';
            currentImage = null;
            dom.ocrBtn.disabled = true;
        }

        async function processOCR() {
            if (!currentImage) {
                showToast('먼저 이미지를 업로드해주세요.', 'error');
                return;
            }
            dom.ocrBtn.disabled = true;
            dom.ocrBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>처리 중...';
            try {
                const result = await Tesseract.recognize(currentImage, 'eng', {
                    logger: m => console.log(m)
                });
                const lines = result.data.text.split('\n');
                if (lines.length > 0 && !dom.merchantName.value) {
                    dom.merchantName.value = lines[0].trim();
                    showToast('사용처가 자동으로 입력되었습니다.');
                }
            } catch (error) {
                console.error('OCR 처리 오류:', error);
                showToast('OCR 처리 중 오류가 발생했습니다.', 'error');
            } finally {
                dom.ocrBtn.disabled = false;
                dom.ocrBtn.innerHTML = '<i class="fas fa-eye mr-2"></i>OCR 처리';
            }
        }

        function calculateTotals() {
            const totalUsdValue = safeParseFloat(dom.subtotal.value) + safeParseFloat(dom.tax.value) + safeParseFloat(dom.tip.value);
            const effectiveExchangeRate = safeParseFloat(dom.appliedExchangeRate.value) || currentExchangeRate;
            dom.totalUsd.value = safeToFixed(totalUsdValue, 2);
            dom.totalKrw.value = `₩${Math.round(totalUsdValue * effectiveExchangeRate).toLocaleString()}`;
        }

        function resetForm() {
            dom.receiptForm.reset();
            const now = new Date();
            dom.receiptDate.value = now.toISOString().split('T')[0];
            let hour12 = now.getHours() % 12 || 12;
            dom.ampm.value = now.getHours() >= 12 ? 'PM' : 'AM';
            dom.hour.value = String(hour12).padStart(2, '0');
            dom.minute.value = String(now.getMinutes()).padStart(2, '0');
            clearImage();
            editingIndex = -1;
            dom.appliedExchangeRate.placeholder = `현재: ${currentExchangeRate.toFixed(2)}`;
            calculateTotals();
            updateSaveButton(false);
        }

        function sortTable(column, keepDirection = false) {
            if (!keepDirection) {
                if (sortState.column === column) {
                    sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    sortState.column = column;
                    sortState.direction = 'asc';
                }
            }
            document.querySelectorAll('.sort-icon').forEach(icon => icon.className = 'fas fa-sort sort-icon');
            const sortIcon = document.getElementById(`sort-${column}`);
            if(sortIcon) sortIcon.className = `fas fa-sort-${sortState.direction === 'asc' ? 'up' : 'down'} sort-icon active`;
            
            const direction = sortState.direction === 'asc' ? 1 : -1;
            receipts.sort((a, b) => {
                const valA = column === 'date' ? new Date(`${a.date}T${a.time}`) : (a[column] || '').toLowerCase();
                const valB = column === 'date' ? new Date(`${b.date}T${b.time}`) : (b[column] || '').toLowerCase();
                if (valA < valB) return -1 * direction;
                if (valA > valB) return 1 * direction;
                return 0;
            });
            renderReceiptsTable();
        }

        function showImageModal(imageSrc) {
            const modalHTML = `
                <div class="modal-overlay visible" id="image-modal-overlay">
                    <div class="modal-content p-0 relative" style="max-width: 90vw; max-height: 90vh;">
                        <img src="${imageSrc}" alt="Receipt" class="max-w-full max-h-full block">
                        <button id="image-modal-close" class="absolute top-2 right-2 bg-black bg-opacity-50 text-white rounded-full w-8 h-8 flex items-center justify-center text-lg"><i class="fas fa-times"></i></button>
                    </div>
                </div>`;
            dom.modalContainer.innerHTML = modalHTML;
            dom.modalContainer.querySelector('#image-modal-overlay').addEventListener('click', (e) => {
                if (e.target.id === 'image-modal-overlay' || e.target.closest('#image-modal-close')) {
                    dom.modalContainer.innerHTML = '';
                }
            });
        }
        
        function showConfirmationModal(message, onConfirm) {
            const modalHTML = `
                <div class="modal-overlay visible" id="confirm-modal-overlay">
                    <div class="modal-content">
                        <p class="text-lg mb-6">${message}</p>
                        <div class="flex justify-center gap-4">
                            <button id="confirm-cancel" class="px-6 py-2 bg-gray-200 rounded-md hover:bg-gray-300">취소</button>
                            <button id="confirm-ok" class="px-6 py-2 bg-red-500 text-white rounded-md hover:bg-red-600">확인</button>
                        </div>
                    </div>
                </div>`;
            dom.modalContainer.innerHTML = modalHTML;
            const overlay = dom.modalContainer.querySelector('#confirm-modal-overlay');
            overlay.querySelector('#confirm-ok').addEventListener('click', () => {
                onConfirm();
                dom.modalContainer.innerHTML = '';
            });
            overlay.querySelector('#confirm-cancel').addEventListener('click', () => {
                dom.modalContainer.innerHTML = '';
            });
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast-notification ${type === 'error' ? 'bg-red-600' : 'bg-gray-800'}`;
            toast.textContent = message;
            dom.toastContainer.appendChild(toast);
            setTimeout(() => {
                toast.classList.add('show');
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 500);
                }, 3000);
            }, 10);
        }

        function initializeCharts() {
            const pieOptions = { 
                responsive: true, maintainAspectRatio: false, 
                plugins: { 
                    legend: { position: 'bottom', labels: { padding: 20 } },
                    tooltip: { callbacks: { label: (c) => `${c.label}: $${safeToFixed(c.raw, 2)}` } }
                } 
            };
            if (dom.categoryChartCanvas) {
                categoryChart = new Chart(dom.categoryChartCanvas, { type: 'pie', data: { labels: [], datasets: [{ data: [], backgroundColor: ['#3b82f6', '#22c55e', '#8b5cf6', '#eab308', '#ef4444', '#6b7280'] }] }, options: pieOptions });
            }
            if (dom.merchantChartCanvas) {
                merchantChart = new Chart(dom.merchantChartCanvas, { type: 'pie', data: { labels: [], datasets: [{ data: [], backgroundColor: ['#10b981', '#14b8a6', '#06b6d4', '#0ea5e9', '#6366f1', '#a855f7', '#d946ef', '#ec4899'] }] }, options: pieOptions });
            }
        }

        function exportToCSV() {
            if (receipts.length === 0) {
                showToast('내보낼 데이터가 없습니다.', 'error');
                return;
            }
            const headers = ['날짜', '시간', '항목', '사용목적', '사용처', 'Total(USD)', '적용 환율', 'Total(KRW)'];
            const csvContent = [
                headers.join(','),
                ...receipts.map(r => [
                    r.date.replace(/-/g, '/'), r.time, `"${r.category || ''}"`, `"${r.purpose || ''}"`,
                    `"${r.merchant}"`, safeToFixed(r.totalUsd, 2), safeToFixed(r.exchangeRate, 2),
                    Math.round(safeParseFloat(r.totalKrw))
                ].join(','))
            ].join('\n');
            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `영수증_기록_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
        }
    </script>
</body>
</html>
