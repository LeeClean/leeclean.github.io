<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>USD/KRW 환율 계산기 v1.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* 스피너 애니메이션 */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* type=number의 기본 스피너를 숨기지 않도록 관련 CSS 제거 */
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-4xl">
        <!-- 헤더 -->
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-slate-900">USD/KRW 환율 계산기 v1.0</h1>
            <p class="text-slate-500 mt-2">최신 환율 변동을 확인하고 금액을 변환합니다.</p>
            <p class="text-sm text-slate-400 mt-1">by Brian Myungsun Lee (leeclean@gmail.com) / 2025.08</p>
        </header>

        <main>
            <!-- 환율 정보 카드 -->
            <div class="bg-white p-6 rounded-xl shadow-md border border-slate-200 mb-8">
                <div id="current-rate-loader" class="flex justify-center items-center h-16"><div class="loader"></div></div>
                <div id="current-rate-display" class="hidden">
                    <div class="flex justify-between items-baseline">
                        <h2 class="text-xl font-semibold text-slate-700">현재 환율</h2>
                        <p class="text-2xl sm:text-3xl font-bold text-blue-600">1 USD = <span id="current-rate"></span> KRW</p>
                    </div>
                    <p class="text-sm text-slate-500 mt-2 text-right">업데이트: <span id="last-updated"></span></p>
                </div>
            </div>

            <!-- 환율 변동 표 -->
            <div class="grid md:grid-cols-2 gap-8 mb-8">
                <!-- 주간 환율 -->
                <div class="bg-white p-6 rounded-xl shadow-md border border-slate-200">
                    <h3 class="text-lg font-semibold mb-4 text-slate-700">주간 환율 변동 (최근 7일)</h3>
                    <div id="weekly-table-loader" class="flex justify-center items-center h-48"><div class="loader"></div></div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full text-sm text-left text-slate-500 hidden" id="weekly-table-container">
                            <thead class="text-xs text-slate-700 uppercase bg-slate-100">
                                <tr>
                                    <th scope="col" class="px-4 py-3 rounded-l-lg">날짜</th>
                                    <th scope="col" class="px-4 py-3 rounded-r-lg text-right">환율 (KRW)</th>
                                </tr>
                            </thead>
                            <tbody id="weekly-rates">
                                <!-- 데이터가 여기에 삽입됩니다. -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <!-- 월간 환율 -->
                <div class="bg-white p-6 rounded-xl shadow-md border border-slate-200">
                    <h3 class="text-lg font-semibold mb-4 text-slate-700">월간 환율 변동 (최근 7주)</h3>
                    <div id="monthly-table-loader" class="flex justify-center items-center h-48"><div class="loader"></div></div>
                     <div class="overflow-x-auto">
                        <table class="min-w-full text-sm text-left text-slate-500 hidden" id="monthly-table-container">
                            <thead class="text-xs text-slate-700 uppercase bg-slate-100">
                                <tr>
                                    <th scope="col" class="px-4 py-3 rounded-l-lg">날짜 (주 단위)</th>
                                    <th scope="col" class="px-4 py-3 rounded-r-lg text-right">환율 (KRW)</th>
                                </tr>
                            </thead>
                            <tbody id="monthly-rates">
                                <!-- 데이터가 여기에 삽입됩니다. -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 환율 계산기 -->
            <div class="bg-white p-6 rounded-xl shadow-md border border-slate-200">
                <div class="flex justify-between items-center mb-6">
                     <h2 class="text-xl font-semibold text-slate-700 w-1/4">환율 계산기</h2>
                     <div class="grid grid-cols-2 gap-4 w-3/4">
                        <h3 class="text-md font-semibold text-slate-600 text-center">미국 달러 (USD)</h3>
                        <h3 class="text-md font-semibold text-slate-600 text-center">한국 원화 (KRW)</h3>
                     </div>
                </div>

                <div class="space-y-4">
                    <!-- Subtotal -->
                    <div class="flex items-center gap-4">
                        <label class="w-1/4 text-md font-medium text-slate-600">Subtotal:</label>
                        <div class="w-3/4 grid grid-cols-2 gap-4">
                            <div class="relative">
                                <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-slate-500">$</span>
                                <input type="number" step="0.01" id="usd-subtotal" class="bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full pl-8 p-2.5 text-left" placeholder="0.00">
                            </div>
                            <div class="relative">
                                <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-slate-500">₩</span>
                                <input type="text" inputmode="decimal" id="krw-subtotal" class="bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full pl-8 p-2.5 text-right" placeholder="0">
                            </div>
                        </div>
                    </div>
                    <!-- Tax -->
                    <div class="flex items-center gap-4">
                        <label class="w-1/4 text-md font-medium text-slate-600">Tax:</label>
                        <div class="w-3/4 grid grid-cols-2 gap-4">
                            <div class="relative">
                                <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-slate-500">$</span>
                                <input type="number" step="0.01" id="usd-tax" class="bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full pl-8 p-2.5 text-left" placeholder="0.00">
                            </div>
                            <div class="relative">
                                <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-slate-500">₩</span>
                                <input type="text" inputmode="decimal" id="krw-tax" class="bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full pl-8 p-2.5 text-right" placeholder="0">
                            </div>
                        </div>
                    </div>
                    <!-- Tip -->
                    <div class="flex items-center gap-4">
                        <label class="w-1/4 text-md font-medium text-slate-600">Tip:</label>
                        <div class="w-3/4 grid grid-cols-2 gap-4">
                            <div class="relative">
                                <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-slate-500">$</span>
                                <input type="number" step="0.01" id="usd-tip" class="bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full pl-8 p-2.5 text-left" placeholder="0.00">
                            </div>
                            <div class="relative">
                                <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-slate-500">₩</span>
                                <input type="text" inputmode="decimal" id="krw-tip" class="bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full pl-8 p-2.5 text-right" placeholder="0">
                            </div>
                        </div>
                    </div>
                    <!-- Divider -->
                    <hr class="my-4 border-slate-200">
                    <!-- Total -->
                    <div class="flex items-center gap-4">
                        <label class="w-1/4 text-xl font-bold text-slate-800">Total:</label>
                        <div class="w-3/4 grid grid-cols-2 gap-4">
                            <div class="text-right text-xl font-bold text-blue-600" id="usd-total">$0.00</div>
                            <div class="text-right text-xl font-bold text-blue-600" id="krw-total">₩0</div>
                        </div>
                    </div>
                </div>
                 <div id="converter-error" class="text-red-500 text-sm mt-4 text-center hidden">환율 정보를 불러오는 데 실패했습니다. 잠시 후 다시 시도해주세요.</div>
            </div>
        </main>
        
        <footer class="text-center mt-8 text-sm text-slate-400">
            <p>환율 정보는 Frankfurter API를 기반으로 제공됩니다.</p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // API 엔드포인트
            const API_URL_LATEST = 'https://api.frankfurter.app/latest?from=USD&to=KRW';
            const API_URL_HISTORICAL = 'https://api.frankfurter.app/';

            // DOM 요소
            const currentRateEl = document.getElementById('current-rate');
            const lastUpdatedEl = document.getElementById('last-updated');
            const weeklyRatesBody = document.getElementById('weekly-rates');
            const monthlyRatesBody = document.getElementById('monthly-rates');
            
            const currentRateLoader = document.getElementById('current-rate-loader');
            const currentRateDisplay = document.getElementById('current-rate-display');
            const weeklyTableLoader = document.getElementById('weekly-table-loader');
            const weeklyTableContainer = document.getElementById('weekly-table-container');
            const monthlyTableLoader = document.getElementById('monthly-table-loader');
            const monthlyTableContainer = document.getElementById('monthly-table-container');
            const converterError = document.getElementById('converter-error');

            // 계산기 입력 필드
            const usdSubtotal = document.getElementById('usd-subtotal');
            const krwSubtotal = document.getElementById('krw-subtotal');
            const usdTax = document.getElementById('usd-tax');
            const krwTax = document.getElementById('krw-tax');
            const usdTip = document.getElementById('usd-tip');
            const krwTip = document.getElementById('krw-tip');
            const usdTotal = document.getElementById('usd-total');
            const krwTotal = document.getElementById('krw-total');

            let latestKrwRate = null;

            // 숫자 포맷팅 함수
            const formatDisplayCurrency = (amount, currency) => {
                const options = { style: 'decimal' };
                if (currency === 'KRW_rate') {
                    options.minimumFractionDigits = 2;
                    options.maximumFractionDigits = 2;
                } else if (currency === 'USD') {
                    options.minimumFractionDigits = 2;
                    options.maximumFractionDigits = 2;
                } else { // KRW
                    options.minimumFractionDigits = 0;
                    options.maximumFractionDigits = 0;
                }
                return new Intl.NumberFormat(currency === 'USD' ? 'en-US' : 'ko-KR', options).format(amount);
            };
            
            // 날짜 포맷팅 함수
            const formatDate = (date) => date.toISOString().split('T')[0];
            const formatDateWithDay = (dateString) => {
                const days = ['일', '월', '화', '수', '목', '금', '토'];
                const date = new Date(dateString + 'T00:00:00');
                return `${dateString}(${days[date.getDay()]})`;
            };

            // API 호출 함수
            async function fetchRate(url) {
                const response = await fetch(url);
                if (!response.ok) {
                    if (response.status === 404) return null;
                    throw new Error(`Failed to fetch data from ${url}`);
                }
                return response.json();
            }

            // 최신 환율 정보 가져오기
            async function fetchLatestRate() {
                try {
                    const data = await fetchRate(API_URL_LATEST);
                    if (data && data.rates && data.rates.KRW) {
                        latestKrwRate = data.rates.KRW;
                        currentRateEl.textContent = formatDisplayCurrency(latestKrwRate, 'KRW_rate');
                        lastUpdatedEl.textContent = formatDateWithDay(data.date);
                        currentRateLoader.classList.add('hidden');
                        currentRateDisplay.classList.remove('hidden');
                        setupConverter();
                    } else {
                        throw new Error('Failed to retrieve valid KRW rate from API.');
                    }
                } catch (error) {
                    console.error('Error fetching latest rate:', error);
                    currentRateDisplay.innerHTML = '<p class="text-red-500 text-center">데이터 로딩 실패</p>';
                    converterError.classList.remove('hidden');
                    currentRateLoader.classList.add('hidden');
                }
            }

            // 과거 환율 정보 가져오기
            async function fetchHistoricalRate(date) {
                try {
                    const data = await fetchRate(`${API_URL_HISTORICAL}${date}?from=USD&to=KRW`);
                    return data && data.rates && data.rates.KRW ? data.rates.KRW : null;
                } catch (error) {
                    console.error(`Error fetching historical rate for ${date}:`, error);
                    return null;
                }
            }

            // 환율 표 채우기
            async function populateRateTable(element, loader, container, days, isWeekly) {
                const today = new Date();
                const promises = Array.from({ length: days }, (_, i) => {
                    const date = new Date(today);
                    date.setDate(today.getDate() - (isWeekly ? i : i * 7));
                    const formattedDate = formatDate(date);
                    return { date: formattedDate, promise: fetchHistoricalRate(formattedDate) };
                });

                element.innerHTML = '';
                for (const item of promises) {
                    const rate = await item.promise;
                    if (rate) {
                        element.innerHTML += `
                            <tr class="border-b border-slate-200 hover:bg-slate-50">
                                <td class="px-4 py-3 font-medium text-slate-900">${formatDateWithDay(item.date)}</td>
                                <td class="px-4 py-3 text-right">${formatDisplayCurrency(rate, 'KRW_rate')}</td>
                            </tr>`;
                    }
                }
                loader.classList.add('hidden');
                container.classList.remove('hidden');
            }

            // 계산기 설정
            function setupConverter() {
                if (!latestKrwRate) return;
                updateTotals(); // 초기 총액 계산
                
                [usdSubtotal, krwSubtotal, usdTax, krwTax, usdTip, krwTip].forEach(input => {
                    input.addEventListener('input', (e) => convert(e.target.id));
                });

                // USD 입력 필드에 blur 이벤트 추가하여 소수점 2자리 포맷팅
                [usdSubtotal, usdTax, usdTip].forEach(input => {
                    input.addEventListener('blur', (e) => {
                        const value = parseFloat(e.target.value) || 0;
                        e.target.value = value.toFixed(2);
                    });
                });
            }

            function convert(sourceId) {
                if (!latestKrwRate) return;
                
                const getNumericValue = (el) => parseFloat(String(el.value).replace(/,/g, '')) || 0;

                const pairs = {
                    'usd-subtotal': { target: krwSubtotal, isUsd: true }, 'krw-subtotal': { target: usdSubtotal, isUsd: false },
                    'usd-tax': { target: krwTax, isUsd: true }, 'krw-tax': { target: usdTax, isUsd: false },
                    'usd-tip': { target: krwTip, isUsd: true }, 'krw-tip': { target: usdTip, isUsd: false }
                };
                
                const sourceInfo = pairs[sourceId];
                if(sourceInfo) {
                    const sourceElement = document.getElementById(sourceId);
                    const sourceValue = getNumericValue(sourceElement);
                    let targetValue;

                    if (sourceInfo.isUsd) {
                        targetValue = sourceValue * latestKrwRate;
                        sourceInfo.target.value = formatDisplayCurrency(targetValue, 'KRW');
                    } else {
                        targetValue = sourceValue / latestKrwRate;
                        // KRW 입력 시 USD 필드는 blur 이벤트에서 포맷팅되므로 toFixed만 적용
                        sourceInfo.target.value = targetValue.toFixed(2);
                    }
                }
                updateTotals();
            }

            function updateTotals() {
                const getNumericValue = (el) => {
                    const value = String(el.value).replace(/,/g, '');
                    return parseFloat(value) || 0;
                }
                
                const totalUsd = getNumericValue(usdSubtotal) + getNumericValue(usdTax) + getNumericValue(usdTip);
                const totalKrw = getNumericValue(krwSubtotal) + getNumericValue(krwTax) + getNumericValue(krwTip);

                usdTotal.textContent = `$${formatDisplayCurrency(totalUsd, 'USD')}`;
                krwTotal.textContent = `₩${formatDisplayCurrency(totalKrw, 'KRW')}`;
            }

            // 앱 초기화
            function init() {
                fetchLatestRate();
                populateRateTable(weeklyRatesBody, weeklyTableLoader, weeklyTableContainer, 7, true);
                populateRateTable(monthlyRatesBody, monthlyTableLoader, monthlyTableContainer, 7, false);
            }

            init();
        });
    </script>
</body>
</html>